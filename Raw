-- FIREBASE CLOUD CHAT (Fresh Session Edition)
local FIREBASE_URL = "https://robloxchat-86a69-default-rtdb.asia-southeast1.firebasedatabase.app/"

-- [[ RANK CONFIGURATION ]] --
local RANKS = {
    ["GauravYTR1866"] = {Tag = "CREATOR", Color = "RAINBOW"},
    ["megotbanned54"] = {Tag = "ADMIN", Color = Color3.fromRGB(85, 170, 255)},
}

-- Auto-Fix URL
if not FIREBASE_URL:find(".json") then
    FIREBASE_URL = FIREBASE_URL:sub(-1) == "/" and FIREBASE_URL .. "chat.json" or FIREBASE_URL .. "/chat.json"
end

local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local UserInputService = game:GetService("UserInputService")
local TextChatService = game:GetService("TextChatService")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer
local request = (syn and syn.request) or (http and http.request) or http_request or (fluxus and fluxus.request) or request

local startTime = os.time() -- Used to ignore old messages

-- --- UI CONSTRUCTION ---
local ScreenGui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
ScreenGui.Name = "CloudChatFresh"
ScreenGui.ResetOnSpawn = false

-- [[ TOGGLE BUTTON (LOCKED TO LEFT) ]] --
local ToggleBtn = Instance.new("TextButton", ScreenGui)
ToggleBtn.Size = UDim2.new(0, 40, 0, 100)
ToggleBtn.Position = UDim2.new(0, 5, 0.5, -50) -- Anchored to LEFT edge
ToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
ToggleBtn.BackgroundTransparency = 0.4
ToggleBtn.TextColor3 = Color3.new(1, 1, 1)
ToggleBtn.Text = "C\nH\nA\nT"
ToggleBtn.Font = Enum.Font.BuilderSansBold
ToggleBtn.TextSize = 14
Instance.new("UICorner", ToggleBtn)
Instance.new("UIStroke", ToggleBtn).Color = Color3.new(1,1,1)

-- [[ MAIN WINDOW ]] --
local Main = Instance.new("Frame", ScreenGui)
Main.Size = UDim2.new(0, 350, 0, 250)
Main.Position = UDim2.new(0.5, -175, 0.5, -125)
Main.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
Main.BackgroundTransparency = 0.4
Main.Active = true
Main.Visible = true
Instance.new("UICorner", Main)

-- Dragging Logic
local dragging, dragStart, startPos
Main.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true; dragStart = input.Position; startPos = Main.Position
        input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end)
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = input.Position - dragStart
        Main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

ToggleBtn.MouseButton1Click:Connect(function() Main.Visible = not Main.Visible end)

-- Scrolling and Input
local Scroll = Instance.new("ScrollingFrame", Main)
Scroll.Size = UDim2.new(1, -10, 1, -60); Scroll.Position = UDim2.new(0, 5, 0, 5)
Scroll.BackgroundTransparency = 1; Scroll.ScrollBarThickness = 0
Scroll.CanvasSize = UDim2.new(0, 0, 0, 0); Scroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
local List = Instance.new("UIListLayout", Scroll); List.Padding = UDim.new(0, 2)

local InputFrame = Instance.new("Frame", Main)
InputFrame.Size = UDim2.new(1, -10, 0, 36); InputFrame.Position = UDim2.new(0, 5, 1, -41)
InputFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0); InputFrame.BackgroundTransparency = 0.2
Instance.new("UICorner", InputFrame)
local Input = Instance.new("TextBox", InputFrame)
Input.Size = UDim2.new(1, -10, 1, 0); Input.Position = UDim2.new(0, 8, 0, 0); Input.BackgroundTransparency = 1; Input.TextColor3 = Color3.new(1,1,1)
Input.PlaceholderText = 'To chat click here...'; Input.Text = ""; Input.Font = Enum.Font.BuilderSansMedium; Input.TextSize = 16; Input.TextXAlignment = Enum.TextXAlignment.Left

-- --- RAINBOW & COLORS ---
local rainbowLabels = {}
local NAME_COLORS = {Color3.fromRGB(253, 41, 67), Color3.fromRGB(1, 162, 255), Color3.fromRGB(2, 184, 87), Color3.fromRGB(170, 85, 255), Color3.fromRGB(255, 170, 0)}

local function getUniqueColor(name)
    local num = 0
    for i = 1, #name do num = num + name:byte(i) end
    return NAME_COLORS[(num % #NAME_COLORS) + 1]
end

RunService.Heartbeat:Connect(function()
    local t = tick()
    local color = Color3.fromHSV(t % 3 / 3, 0.8, 1)
    for label, data in pairs(rainbowLabels) do
        label.Text = string.format('<font color="#%s">[%s]</font> <font color="#%s">[%s]</font>: <font face="BuilderSansMedium">%s</font>', 
            color:ToHex(), data.tag, data.nameColor:ToHex(), data.name, data.content)
    end
end)

-- --- CORE LOGIC ---
local seenMessages = {}

local function addMessage(displayName, content, username)
    local nameColor = getUniqueColor(displayName)
    local rankData = RANKS[username]
    local Label = Instance.new("TextLabel", Scroll)
    Label.Size = UDim2.new(1, 0, 0, 0); Label.AutomaticSize = Enum.AutomaticSize.Y
    Label.BackgroundTransparency = 1; Label.RichText = true
    Label.Font = Enum.Font.BuilderSansBold; Label.TextSize = 16; Label.TextColor3 = Color3.new(1,1,1)
    Label.TextXAlignment = Enum.TextXAlignment.Left; Label.TextWrapped = true

    if rankData and rankData.Color == "RAINBOW" then
        rainbowLabels[Label] = {tag = rankData.Tag, name = displayName, nameColor = nameColor, content = content}
    else
        local rankTag = rankData and string.format('<font color="#%s">[%s]</font> ', rankData.Color:ToHex(), rankData.Tag) or ""
        Label.Text = string.format('%s<font color="#%s">[%s]</font>: <font face="BuilderSansMedium">%s</font>', rankTag, nameColor:ToHex(), displayName, content)
    end
    Scroll.CanvasPosition = Vector2.new(0, 99999)
end

local function postMessage()
    local text = Input.Text; if text == "" then return end
    Input.Text = ""; task.spawn(function()
        request({Url = FIREBASE_URL, Method = "POST", Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode({
                sender = player.DisplayName, 
                content = text, 
                realName = player.Name,
                timestamp = os.time() -- Save time sent
            })})
    end)
end

local function updateChat()
    local success, response = pcall(function() return request({Url = FIREBASE_URL, Method = "GET"}) end)
    if success and response.Body then
        local ok, data = pcall(function() return HttpService:JSONDecode(response.Body) end)
        if ok and type(data) == "table" then
            for id, msg in pairs(data) do
                -- ONLY show messages sent AFTER we started the script
                if not seenMessages[id] and (msg.timestamp and msg.timestamp >= startTime) then
                    seenMessages[id] = true
                    addMessage(msg.sender or "Unknown", msg.content or "", msg.realName or "")
                    local speaker = Players:FindFirstChild(msg.realName or "")
                    if speaker and speaker.Character and speaker.Character:FindFirstChild("Head") then
                        TextChatService:DisplayBubble(speaker.Character.Head, msg.content)
                    end
                end
            end
        end
    end
end

Input.FocusLost:Connect(function(enter) if enter then postMessage() end end)
task.spawn(function() while true do updateChat(); task.wait(3) end end)
